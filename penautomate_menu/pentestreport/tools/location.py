# Importing necessary libraries
import requests
import socket
import json
import os

json_path = os.path.join("penautomate_menu", "pentestreport", "pentestdata.json")
json_output_path = os.path.join("penautomate_menu", "pentestreport", "pentestreport.json")

def fetch_information(domain):
    try:
        # Try to fetch HTTP request headers for the domain
        req = requests.get("https://" + domain)

        # Obtain the IP address associated with the domain
        ip_addr = socket.gethostbyname(domain)

        # Make a request to obtain information about the IP address
        req2 = requests.get(f"https://ipinfo.io/{ip_addr}/json")
        data = json.loads(req2.text)

        # Gathered API information, managing missing data, without headers
        return {
            "ip_address": ip_addr,
            "hostname": data.get('hostname', 'Not available'),
            "city": data.get('city', 'Not available'),
            "region": data.get('region', 'Not available'),
            "country": data.get('country', 'Not available'),
            "location": data.get('loc', 'Not available'),
            "organization": data.get('org', 'Not available'),
            "postal": data.get('postal', 'Not available'),
            "timezone": data.get('timezone', 'Not available')
        }
    except requests.exceptions.RequestException as e:
        # Handle request errors
        return {"error": f"Failed to retrieve data for {domain}: {str(e)}"}


def get_domain_information(domain):
    if not domain.startswith("www."):
        # Add 'www.' if not already present and try to fetch the information
        www_domain = "www." + domain
        info = fetch_information(www_domain)
        if isinstance(info, dict):
            return info
        else:
            # If adding 'www.' fails, try without 'www.'
            return fetch_information(domain)
    else:
        # Try directly if 'www.' is already present
        return fetch_information(domain)

# Read domain from JSON instead of input
with open(json_path, 'r') as file:
    data = json.load(file)
    domain = data['Company Domain']

# Get information for the domain
info = get_domain_information(domain)

# Write the information to a JSON file, creating or overwriting the existing file
with open(json_output_path, 'w') as json_file:
    json.dump(info, json_file, indent=4)