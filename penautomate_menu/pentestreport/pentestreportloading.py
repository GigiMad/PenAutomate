import customtkinter
import subprocess
import json
import os
from PIL import Image, ImageTk
import socket
import threading
import time
from CTkMessagebox import CTkMessagebox

# Empêche la résolution automatique de Windows
customtkinter.deactivate_automatic_dpi_awareness()

# Chemin des images et des fichiers
icon_path = os.path.join("penautomate_images", "penautomate.ico")
back_path = os.path.join("penautomate_menu", "pentestreport", "pentestreportscan.py")
json_path = os.path.join("penautomate_menu", "pentestreport", "pentestdata.json")
next_path = os.path.join("penautomate_menu", "pentestreport", "pentestreportloading.py")
location_path = os.path.join("penautomate_menu", "pentestreport", "tools", "location.py")

# Fenêtre root
root = customtkinter.CTk()
root.geometry("350x350")
root.title("PenAutomate")
root.iconbitmap(icon_path)
root.resizable(width=False, height=False)

# Centre la fenêtre au lancement
root.update_idletasks()
screen_width = root.winfo_screenwidth()
screen_height = root.winfo_screenheight()
window_width = root.winfo_width()
window_height = root.winfo_height()
x_pos = (screen_width - window_width) // 2
y_pos = (screen_height - window_height) // 2
root.geometry("+{}+{}".format(x_pos, y_pos))    

# Importe la configuration du thème Light / Dark depuis le fichier themes.json
with open('themes.json', 'r') as file:
    config = json.load(file)

# Apparence du thème
customtkinter.set_appearance_mode(config["appearance_mode"])
customtkinter.set_default_color_theme("dark-blue")

def launch_report():
    # Affiche et démarre la barre de progression
    progressbar.pack(pady=10, padx=10)
    progressbar.start()
    
    subprocess.run(['python', location_path], capture_output=True, text=True)

    subprocess.run(['python', location_path], capture_output=True, text=True)   

    # Simulez une opération longue durée (comme la génération de rapport)
    time.sleep(5)  # Simule un traitement qui prend du temps


# Frame du menu
frame = customtkinter.CTkFrame(master=root)
frame.pack(fill="y", expand=True, side="top")

# Titre de la frame
label = customtkinter.CTkLabel(master=frame, text="\U0001f47e   Creating Report   \U0001f47e", font=("Lato", 24, "bold"))
label.pack(pady=12, padx=10)

# Description de la frame
label = customtkinter.CTkLabel(master=frame, text="The wait may be longer depending on \nthe number of IP addresses entered \nand the number of features requested.", font=("Lato", 10, "bold"), wraplength=400)
label.pack()

progressbar = customtkinter.CTkProgressBar(master=root, width=500, mode="indeterminate")

# BOUTON REPORT
report_button = customtkinter.CTkButton(master=frame, text="Generate Report", command=launch_report, font=("Lato", 14, "bold"), fg_color="#22B14C", hover_color="#1A873A")
report_button.pack(pady=50)


# Main Loop
root.mainloop()
